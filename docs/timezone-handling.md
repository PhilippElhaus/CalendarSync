# Timezone handling rationale

The sync now treats Outlook and iCloud calendars with explicit source and target timezones instead of relying on the host operating system. Optional `SourceTimeZoneId` and `TargetTimeZoneId` values in `config.json` allow overriding the defaults when Outlook runs in a different region than the machine or when iCloud should display in a different zone. When the fields are omitted the code falls back to `TimeZoneInfo.Local` for both roles.

Outlook appointment data is normalised through `NormalizeOutlookTimes`, which now treats the UTC values exposed by Outlook (`StartUTC`/`EndUTC`) as the single source of truth. Those timestamps are converted into the configured source timezone to build stable “local” values. When Outlook omits UTC values, the service falls back to converting the provided local timestamp via the configured source timezone. Any inconsistencies trigger warnings and are corrected before writing to iCloud. All conversions back to UTC go through `ConvertFromSourceLocalToUtc`, while `ConvertUtcToSourceLocal` is used to derive local display values when expanding recurrences. The helper `EnsureEventConsistency` runs over every item before it is queued for upload and splits all-day multi-day events using the same timezone-aware calculations.

For recurring events the service rebuilds the calendar series using the source timezone to anchor the series, evaluates exceptions with normalised start/end values and requests occurrences from iCal.Net in UTC. The resulting occurrences are converted back to the configured source timezone to check for skipped dates and to build per-instance payloads. Every payload is verified with `CheckTargetAlignment` to ensure that converting the UTC timestamps to the target timezone would not shift the local wall-clock time unexpectedly when the source and target zones match. These steps prevent previously observed two-hour offsets when both calendars operate in CET and make the conversion robust across differing source/target zones.
